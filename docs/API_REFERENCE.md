# AINSpace API Reference

This document summarizes the Next.js Route Handler APIs located under `src/app/api`. Unless otherwise noted, responses use the `application/json` media type and timestamps are formatted as ISO 8601 strings.

## Common Details
- **Base URL**: `/api`
- **Environment Variables**
  - `AINSPACE_STORAGE_REDIS_URL` – Redis connection string (optional, defaults to local Redis)
  - `OPENAI_API_KEY` – required for the `/convert-image` endpoint that calls DALL·E image editing
  - `GEMINI_API_KEY` – required for `/agent-response` and `/commentary` (Google Gemini)
  - `AINSPACE_BLOB_READ_WRITE_TOKEN` – required for `/upload-tile` uploads to Vercel Blob Storage
- Some endpoints fall back to an in-memory store when Redis is unavailable (for example, `/agents`).

## Endpoint Overview

| Method | Path | Description |
| --- | --- | --- |
| GET | `/agents` | List stored agent cards |
| POST | `/agents` | Store an agent card |
| DELETE | `/agents` | Delete an agent (query `url`) |
| POST | `/agent-proxy` | Fetch an agent card from an A2A card URL |
| POST | `/agent-response` | Generate agent dialogue with Gemini |
| POST | `/agent-chat` | Chat with a single A2A agent |
| POST | `/create-agent` | Create and deploy a new agent via prompt |
| GET | `/custom-tiles` | Retrieve custom tile layers (query `userId`) |
| POST | `/custom-tiles` | Save custom tile layers |
| POST | `/convert-image` | Start an image-to-RPG-tile conversion job |
| GET | `/convert-status` | Check conversion job status (query `jobId`) |
| GET | `/clear-layer1` | Reset the global layer1 tile bucket |
| GET | `/position` | Fetch stored player position (query `userId`) |
| POST | `/position` | Save player position |
| POST | `/thread-message` | Send a message to an A2A thread and bind agents |
| GET | `/thread-stream/{threadId}` | Proxy the SSE thread stream |
| GET | `/threads` | Fetch user thread mappings (query `userId`) |
| POST | `/threads` | Save a thread mapping |
| DELETE | `/threads` | Delete a thread mapping (query `userId`, `threadName`) |
| POST | `/upload-tile` | Upload tile PNG via multipart/form-data |
| GET | `/test-agent` | Test-fetch an external agent card |
| GET | `/sentry-example-api` | Throw a Sentry test error |

Detailed descriptions follow.

---

## `/agents`

### GET `/agents`
- **Description**: Returns every stored agent ordered by most recent. The handler first queries Redis keys prefixed with `agents:`; if Redis is unavailable it falls back to the in-memory map.
- **Response**
  ```json
  {
    "success": true,
    "agents": [
      {
        "url": "https://...",
        "card": { "name": "Explorer Bot", "...": "..." },
        "timestamp": 1718350123456
      }
    ]
  }
  ```
- **Errors**: Internal issues (for example Redis failures) return `500`.

### POST `/agents`
- **Description**: Persists an agent card. Duplicate URLs are allowed; the handler returns `duplicate: true` but still responds with `200`.
- **Request Body**
  ```json
  {
    "agentUrl": "https://.../.well-known/agent.json",
    "agentCard": { "name": "Explorer Bot", "...": "..." }
  }
  ```
- **Response**: Includes the stored URL and card along with `success: true`. When a duplicate is encountered the response also contains `message: "Agent already exists"` and `duplicate: true`.
- **Errors**: Missing fields return `400`; storage failures return `500`.

### DELETE `/agents?url=<agentUrl>`
- **Description**: Removes the agent with the matching URL from Redis or the fallback store.
- **Errors**: Missing record returns `404`.

---

## POST `/agent-proxy`
- **Description**: Given an A2A card URL, creates an A2A SDK client on the server and returns the agent card payload.
- **Request Body**
  ```json
  { "agentUrl": "https://.../.well-known/agent.json" }
  ```
- **Response**: `{ "success": true, "agentUrl": "...", "agentCard": { ... } }`
- **Errors**: Missing `agentUrl` returns `400`; fetch or SDK failures return `500`.

---

## POST `/agent-response`
- **Description**: Calls `generateAgentResponse` in `src/lib/gemini.ts` to generate contextual dialogue for an agent inside the tile-based game.
- **Sample Request**
  ```json
  {
    "agentData": {
      "name": "Explorer Bot",
      "behavior": "explorer",
      "position": { "x": 1, "y": 5 },
      "playerPosition": { "x": 2, "y": 7 },
      "distance": 4.1,
      "userMessage": "Hello!"
    }
  }
  ```
- **Response**
  ```json
  {
    "response": "Dialogue generated by Gemini",
    "timestamp": "2024-06-14T05:15:32.123Z"
  }
  ```
- **Errors**: Missing `agentData` returns `400`; other issues return `500`.

---

## POST `/agent-chat`
- **Description**: Sends a message to a single A2A agent. Optionally accepts a `contextId` to keep an ongoing conversation.
- **Request Body**
  ```json
  {
    "agentUrl": "https://.../.well-known/agent.json",
    "message": "Hi!",
    "contextId": "optional-context-id",
    "metadata": { "tileId": "123" }
  }
  ```
- **Response**
  ```json
  {
    "success": true,
    "response": "Agent reply text",
    "contextId": "original-or-new",
    "taskId": "optional-task-id",
    "fullResponse": { "...": "Raw A2A SDK response" }
  }
  ```
- **Errors**: Missing `agentUrl` or `message` returns `400`; communication failures return `500`.

---

## POST `/commentary`
- **Description**: Generates world narration from the given `gameState` using the Gemini API.
- **Request Body**
  ```json
  {
    "gameState": {
      "worldPosition": { "x": 10, "y": 12 },
      "currentTerrain": "grass",
      "visibleAgents": [{ "name": "Explorer Bot", "color": "#00f" }],
      "recentMovements": ["N", "E", "E"],
      "biome": "forest"
    }
  }
  ```
- **Response**: `{ "commentary": "...", "timestamp": "..." }`

---

## POST `/create-agent`
- **Description**: Interacts with the AINetwork A2A Builder service to generate and deploy an agent derived from a natural language prompt.
- **Request Body**
  ```json
  { "prompt": "Describe the agent you want to build" }
  ```
- **Flow**
  1. `POST /api/generate-agent` to obtain a base config.
  2. Add required fields (`id`, `url`, `protocolVersion`, etc.).
  3. `POST /api/deploy-agent` to publish the agent.
- **Response**
  ```json
  {
    "success": true,
    "url": "https://.../.well-known/agent.json",
    "agentId": "agent-<timestamp>",
    "config": { "...": "Augmented configuration" }
  }
  ```
- **Errors**: Each upstream call propagates its status code and error message.

---

## `/custom-tiles`

### GET `/custom-tiles?userId=<id>`
- **Description**: Loads tile layers from the global `global-tiles` key. The `userId` parameter is accepted for legacy compatibility but currently ignored.
- **Response**
  ```json
  {
    "tiles": {
      "layer0": { "...": "..." },
      "layer1": {},
      "layer2": {}
    },
    "lastUpdated": "2024-06-14T05:10:32.123Z",
    "isDefault": false
  }
  ```
- **Errors**: Redis issues return `500`.

### POST `/custom-tiles`
- **Description**: Merges supplied tile layers with existing global tiles and persists the result.
- **Request Body**
  ```json
  {
    "userId": "0x123...",
    "customTiles": {
      "layer0": { "tileId": "asset-url" },
      "layer1": {},
      "layer2": {}
    }
  }
  ```
- **Response**: Includes `success: true`, the total tile count merged, and `savedAt`.
- **Errors**: Invalid payloads return `400`; persistence errors return `500`.

---

## `/convert-image`

### POST `/convert-image`
- **Description**: Accepts an uploaded image and submits a background edit request to OpenAI DALL·E 2. Returns a `jobId` immediately while processing continues asynchronously.
- **Content Type**: `multipart/form-data`
  - `image`: file (required)
- **Response**
  ```json
  {
    "success": true,
    "jobId": "job_1718350123456_abcd123",
    "message": "Image conversion started. Use the jobId to check status."
  }
  ```
- **Errors**: Missing file returns `400`; OpenAI or processing errors return `500`.

### GET `/convert-status?jobId=<id>`
- **Description**: Returns the in-memory job state. Completed or failed jobs expire one hour after creation and subsequently respond with `Job expired`.
- **Response**
  ```json
  {
    "jobId": "job_...",
    "status": "completed",
    "result": "data:image/png;base64,...",
    "error": null
  }
  ```
- **Status Values**: `pending`, `processing`, `completed`, `failed`.
- **Errors**: Missing `jobId` returns `400`; unknown job returns `404`.

---

## GET `/clear-layer1`
- **Description**: Empties the `layer1` bucket inside the global tiles structure stored in Redis while preserving `layer0` and `layer2`. The response summarizes counts before and after the cleanup.

---

## `/position`

### GET `/position?userId=<id>`
- **Description**: Reads a player position from Redis. When no position exists, returns `{ "position": { "x": 0, "y": 0 }, "isDefault": true }`.

### POST `/position`
- **Description**: Persists a player position and sets a 24-hour TTL.
- **Request Body**
  ```json
  {
    "userId": "0x123...",
    "position": { "x": 10, "y": 5 }
  }
  ```
- **Response**: Includes `success: true`, the stored position, and `savedAt`.
- **Errors**: Invalid coordinates or missing fields return `400`.

---

## POST `/thread-message`
- **Description**: Sends a message to an A2A Orchestration thread. If `threadId` is omitted, the handler creates a new thread and adds agents either from the supplied `agentNames` list or by filtering on `broadcastRadius` / `mentionedAgents`.
- **Request Body**
  ```json
  {
    "message": "Hello agents!",
    "playerPosition": { "x": 10, "y": 12 },
    "broadcastRadius": 5,
    "threadId": "optional-existing-thread",
    "agentNames": ["Explorer Bot"],
    "mentionedAgents": ["Patrol Bot"]
  }
  ```
  - If `agentNames` is present, only agents with matching names (case insensitive) are used.
  - Otherwise the backend computes the set using distance and mentions.
  - When a new thread is created, each agent is converted to the A2A format and added before the message is sent.
- **Response**
  ```json
  {
    "success": true,
    "threadId": "generated-or-existing",
    "agentsAdded": 2,
    "totalAgents": 3,
    "isNewThread": true,
    "failedAgents": [
      { "success": false, "agent": "Patrol Bot", "error": { "...": "..." } }
    ]
  }
  ```
- **Errors**: Missing `message` or `playerPosition` returns `400`; no agents found returns `404`; thread creation or message send failures return `500`.

---

## GET `/thread-stream/{threadId}`
- **Description**: Proxies the Server-Sent Events stream provided by A2A Orchestration. The handler forces the Node.js runtime, sets `maxDuration` to five minutes, and forwards the raw event stream to the client.
- **Usage Example**
  ```ts
  const source = new EventSource('/api/thread-stream/abcd');
  source.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log(data);
  };
  ```

---

## `/threads`

### GET `/threads?userId=<id>`
- **Description**: Fetches every thread mapping for the given user from `user:{userId}:threads`.
- **Response**
  ```json
  {
    "success": true,
    "threads": {
      "General": {
        "threadName": "General",
        "backendThreadId": "a2a-thread-id",
        "agentNames": ["Explorer Bot"],
        "createdAt": "...",
        "lastMessageAt": "..."
      }
    }
  }
  ```

### POST `/threads`
- **Description**: Stores a thread mapping and sets a 30-day TTL.
- **Request Body**
  ```json
  {
    "userId": "0x123...",
    "threadName": "General",
    "backendThreadId": "a2a-thread-id",
    "agentNames": ["Explorer Bot", "Patrol Bot"]
  }
  ```

### DELETE `/threads?userId=<id>&threadName=<name>`
- **Description**: Deletes the specified thread mapping for the user.

---

## POST `/upload-tile`
- **Description**: Stores an uploaded PNG in Vercel Blob Storage at `tiles/{tileId}.png` and returns the public URL.
- **Content Type**: `multipart/form-data`
  - `file`: file (required)
  - `tileId`: string (required)
- **Response**
  ```json
  { "success": true, "url": "https://blob.vercel-storage.com/...", "tileId": "sample-tile" }
  ```
- **Errors**: Missing fields return `400`; upload failures return `500`.

---

## GET `/test-agent`
- **Description**: Fetches a hardcoded A2A card URL and returns the body plus response headers. Useful for debugging external connectivity.

---

## GET `/sentry-example-api`
- **Description**: Always throws `SentryExampleAPIError` to validate backend error monitoring with Sentry.

